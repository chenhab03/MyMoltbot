<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¾è‚¡é€‰è‚¡å™¨ Â· SPY è‡ªåŠ¨æˆåˆ†è‚¡</title>
  <style>
    body{font-family:system-ui,-apple-system;background:#0f172a;color:#e5e7eb;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:16px}
    .app{background:#020617;border-radius:16px;padding:16px;width:100%;max-width:980px;box-shadow:0 20px 40px rgba(0,0,0,.4)}
    h1{margin:0 0 8px 0;font-size:22px;text-align:center}
    .hint{font-size:12px;opacity:.85;text-align:center;margin-bottom:12px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    input,button{background:#020617;color:#e5e7eb;border:1px solid #1e293b;border-radius:8px;padding:10px}
    button{background:#38bdf8;color:#020617;font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #1e293b;padding:8px;font-size:12px;text-align:left}
    th{opacity:.8}
    .ok{color:#34d399}
    .bad{color:#f87171}
    .foot{font-size:11px;opacity:.7;margin-top:8px}
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ“ˆ ç¾è‚¡é€‰è‚¡å™¨ï¼ˆSPY è‡ªåŠ¨æˆåˆ†è‚¡ï¼‰</h1>
    <div class="hint">è‡ªåŠ¨åŠ è½½ SPYï¼ˆâ‰ˆ æ ‡æ™® 500ï¼‰å…¨éƒ¨æˆåˆ†è‚¡å¹¶ç­›é€‰ï¼šMACDâ‰ˆ0ï½œä»·æ ¼â‰ˆEMA52ï½œJ&lt;10ï½œå¸‚å€¼&gt;50 äº¿ç¾å…ƒ</div>

    <div class="controls">
      <div>
        <label>MACD è·ç¦»é›¶è½´é˜ˆå€¼</label>
        <input id="macdThr" type="number" step="0.01" value="0.1" />
      </div>
      <div>
        <label>ä»·æ ¼æ¥è¿‘ EMA52 (%)</label>
        <input id="emaPct" type="number" step="0.1" value="2" />
      </div>
      <div>
        <label>J å€¼ä¸Šé™</label>
        <input id="jMax" type="number" value="10" />
      </div>
      <div>
        <label>æœ€å°å¸‚å€¼ï¼ˆåäº¿ç¾å…ƒï¼‰</label>
        <input id="mcapMin" type="number" value="5" />
      </div>
      <div style="grid-column:1/3">
        <button id="run">è‡ªåŠ¨åŠ è½½ SPY æˆåˆ†è‚¡å¹¶ç­›é€‰</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ä»£ç </th><th>æ”¶ç›˜ä»·</th><th>EMA52</th><th>MACD</th><th>J</th><th>å¸‚å€¼(åäº¿ç¾å…ƒ)</th><th>ç»“æœ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="foot">è¯´æ˜ï¼šSPY â‰ˆ æ ‡æ™® 500ã€‚æˆåˆ†è‚¡æ¥æºï¼šWikipediaï¼ˆå‰ç«¯æŠ“å–ï¼‰ã€‚Yahoo Finance å…¬å…±æ¥å£å¯èƒ½é™æµï¼Œé¦–æ¬¡åŠ è½½è¾ƒæ…¢ã€‚</div>
  </div>

<script>
// ===== æŒ‡æ ‡ =====
function EMA(values, period){ const k=2/(period+1); let ema=values[0]; for(let i=1;i<values.length;i++) ema=values[i]*k+ema*(1-k); return ema; }
function MACD(close){ const ema12=EMA(close.slice(-26),12); const ema26=EMA(close.slice(-26),26); return ema12-ema26; }
function KDJ(high, low, close, n=9){ const hs=high.slice(-n); const ls=low.slice(-n); const c=close[close.length-1]; const hh=Math.max(...hs); const ll=Math.min(...ls); const rsv=(c-ll)/(hh-ll)*100; let k=2/3*50+1/3*rsv; let d=2/3*50+1/3*k; let j=3*k-2*d; return {j}; }
function near(a,b,pct){ return Math.abs(a-b)/b*100<=pct; }

// ===== æ•°æ®æº =====
async function fetchSPY(){
  const url='https://en.wikipedia.org/wiki/List_of_S%26P_500_companies';
  const html=await (await fetch(url)).text();
  const doc=new DOMParser().parseFromString(html,'text/html');
  const rows=[...doc.querySelectorAll('table.wikitable tbody tr')];
  return rows.map(r=>r.children[0].textContent.trim()).filter(Boolean);
}
async function fetchDaily(symbol){
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=6mo&interval=1d`;
  const j=await (await fetch(url)).json();
  const res=j.chart.result[0]; const q=res.indicators.quote[0];
  return { close:q.close.filter(Boolean), high:q.high.filter(Boolean), low:q.low.filter(Boolean) };
}
async function fetchMcap(symbol){
  const url=`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
  const j=await (await fetch(url)).json();
  const p=j.quoteSummary.result[0].price; return p.marketCap?.raw? p.marketCap.raw/1e9:null;
}

const tbody=document.getElementById('tbody');

document.getElementById('run').onclick=async()=>{
  tbody.innerHTML='<tr><td colspan="7">åŠ è½½ SPY æˆåˆ†è‚¡ä¸­ï¼Œè¯·ç¨å€™â€¦</td></tr>';
  const syms=await fetchSPY();
  tbody.innerHTML='';
  const macdThr=parseFloat(macdThrEl.value); const emaPct=parseFloat(emaPctEl.value); const jMax=parseFloat(jMaxEl.value); const mcapMin=parseFloat(mcapMinEl.value);
  for(const s of syms){
    try{
      const [ohlc,mcap]=await Promise.all([fetchDaily(s), fetchMcap(s)]);
      const close=ohlc.close; const ema52=EMA(close.slice(-52),52); const macd=MACD(close); const {j}=KDJ(ohlc.high,ohlc.low,close); const last=close[close.length-1];
      const ok=Math.abs(macd)<=macdThr && near(last,ema52,emaPct) && j<jMax && (mcap??0)>=mcapMin;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s}</td><td>${last.toFixed(2)}</td><td>${ema52.toFixed(2)}</td><td>${macd.toFixed(3)}</td><td>${j.toFixed(1)}</td><td>${mcap?mcap.toFixed(1):'â€”'}</td><td class="${ok?'ok':'bad'}">${ok?'é€šè¿‡':'æœªé€šè¿‡'}</td>`;
      tbody.appendChild(tr);
    }catch(e){/* å¿½ç•¥å¤±è´¥ */}
  }
};

const macdThrEl=document.getElementById('macdThr');
const emaPctEl=document.getElementById('emaPct');
const jMaxEl=document.getElementById('jMax');
const mcapMinEl=document.getElementById('mcapMin');
</script>
</body>
</html>