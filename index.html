<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¾·å›½ç”Ÿç‰©åŒ–å­¦åšå£«å²—ä½æœç´¢ Â· æ³•å…°å…‹ç¦</title>
  <style>
    body{font-family:system-ui,-apple-system;background:#0f172a;color:#e5e7eb;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:16px}
    .app{background:#020617;border-radius:16px;padding:16px;width:100%;max-width:1100px;box-shadow:0 20px 40px rgba(0,0,0,.4)}
    h1{margin:0 0 8px 0;font-size:22px;text-align:center}
    .hint{font-size:12px;opacity:.85;text-align:center;margin-bottom:12px}
    .controls{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
    input,select,button{background:#020617;color:#e5e7eb;border:1px solid #1e293b;border-radius:8px;padding:10px}
    button{background:#38bdf8;color:#020617;font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #1e293b;padding:8px;font-size:12px;text-align:left;vertical-align:top}
    th{opacity:.8}
    a{color:#93c5fd;text-decoration:none}
    .ok{color:#34d399}
    .bad{color:#f87171}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#1e293b;font-size:10px;margin-left:6px}
    .foot{font-size:11px;opacity:.7;margin-top:8px}
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ§¬ å¾·å›½å²—ä½çˆ¬å–ï¼ˆç”Ÿç‰©åŒ–å­¦åšå£«ï¼‰</h1>
    <div class="hint">æ•°æ®æºï¼šå¾·å›½è”é‚¦å°±ä¸šå±€ JobbÃ¶rseï¼ˆå®˜æ–¹å¼€æ”¾ APIï¼‰+ EURESï¼ˆæ¬§ç›Ÿå®˜æ–¹ï¼‰ã€‚ä»…æŠ“å–å…è®¸çš„å…¬å¼€æ¥å£ï¼Œä¸æŠ“å–å—é™ç«™ç‚¹ã€‚</div>

    <div class="controls">
      <input id="kw" placeholder="å…³é”®è¯ï¼ˆbiochemistry / life science / postdoc / scientistï¼‰" value="biochemistry scientist" />
      <input id="city" placeholder="åŸå¸‚" value="Frankfurt am Main" />
      <select id="radius">
        <option value="20">20 km</option>
        <option value="30" selected>30 km</option>
        <option value="50">50 km</option>
      </select>
      <button id="run">æœç´¢å²—ä½</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>æ¥æº</th><th>èŒä½</th><th>å•ä½</th><th>åœ°ç‚¹</th><th>è·ç¦»</th><th>é“¾æ¥</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="foot">è¯´æ˜ï¼šæœ¬å·¥å…·ä½¿ç”¨å®˜æ–¹/å¼€æ”¾æ¥å£ï¼ˆBA JobbÃ¶rseã€EURESï¼‰ã€‚å¦‚éœ€è¦†ç›– StepStone/Indeed/LinkedIn ç­‰ç«™ç‚¹ï¼Œå»ºè®®æ”¹ä¸ºæœåŠ¡å™¨ç«¯å¹¶éµå¾ªå„ç«™ ToSã€‚</div>
  </div>

<script>
// ===== ç®€å•åœ°ç†å·¥å…·ï¼ˆHaversineï¼‰ =====
function distKm(a,b){ const R=6371; const dLat=(b.lat-a.lat)*Math.PI/180; const dLon=(b.lon-a.lon)*Math.PI/180; const la1=a.lat*Math.PI/180; const la2=b.lat*Math.PI/180; const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

// ===== åœ°ç†ç¼–ç ï¼ˆNominatimï¼‰ =====
async function geocode(q){ const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`; const j=await (await fetch(u,{headers:{'Accept':'application/json'}})).json(); if(!j[0]) throw new Error('geocode'); return {lat:+j[0].lat, lon:+j[0].lon}; }

// ===== BA JobbÃ¶rseï¼ˆå®˜æ–¹å¼€æ”¾ï¼‰ =====
async function fetchBA({kw,city,radius}){
  const base='https://rest.arbeitsagentur.de/jobboerse/jobsuche-service/pc/v4/jobs';
  const params=new URLSearchParams({ was:kw, wo:city, umkreis:radius, page:1, size:50 });
  const r=await fetch(`${base}?${params.toString()}`,{headers:{'X-API-Key':'jobboerse-jobsuche'}});
  if(!r.ok) throw new Error('BA');
  const j=await r.json();
  return (j.stellenangebote||[]).map(x=>({
    source:'BA JobbÃ¶rse',
    title:x.titel,
    company:x.arbeitgeber?.name||'â€”',
    place:`${x.arbeitsort?.ort||''}`,
    lat:x.arbeitsort?.koordinaten?.breitengrad,
    lon:x.arbeitsort?.koordinaten?.laengengrad,
    url:`https://jobboerse.arbeitsagentur.de/vamJB/stellenangebot?angebotId=${x.refnr}`
  }));
}

// ===== EURESï¼ˆæ¬§ç›Ÿå®˜æ–¹ï¼Œç®€åŒ–æŠ“å–ï¼‰ =====
async function fetchEURES({kw,city,radius}){
  const u=`https://europa.eu/eures/eures-apps/searchengine/pageSearch?page=1&size=50&keywords=${encodeURIComponent(kw)}&place=${encodeURIComponent(city)}`;
  const j=await (await fetch(u)).json();
  return (j?.jobs||[]).map(x=>({
    source:'EURES',
    title:x.title,
    company:x.companyName||'â€”',
    place:x.location||'',
    lat:x.latitude, lon:x.longitude,
    url:x.url
  }));
}

const tbody=document.getElementById('tbody');

document.getElementById('run').onclick=async()=>{
  tbody.innerHTML='<tr><td colspan="6">æœç´¢ä¸­ï¼Œè¯·ç¨å€™â€¦</td></tr>';
  try{
    const kw=document.getElementById('kw').value;
    const city=document.getElementById('city').value;
    const radius=+document.getElementById('radius').value;
    const center=await geocode(city);
    const [ba,eu]=await Promise.all([fetchBA({kw,city,radius}), fetchEURES({kw,city,radius})]);
    const rows=[...ba,...eu].filter(x=>x.lat&&x.lon).map(x=>({ ...x, d: distKm(center,{lat:x.lat,lon:x.lon}) }))
      .filter(x=>x.d<=radius).sort((a,b)=>a.d-b.d);
    tbody.innerHTML='';
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.source}</td><td>${r.title}</td><td>${r.company}</td><td>${r.place}</td><td>${r.d.toFixed(1)} km</td><td><a href="${r.url}" target="_blank">æŸ¥çœ‹</a></td>`;
      tbody.appendChild(tr);
    }
    if(!rows.length) tbody.innerHTML='<tr><td colspan="6">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å²—ä½</td></tr>';
  }catch(e){ tbody.innerHTML='<tr><td colspan="6" class="bad">æœç´¢å¤±è´¥</td></tr>'; }
};
</script>
</body>
</html>